---
import Layout from "@layouts/Layout.astro";
import { getCollection, CollectionEntry } from "astro:content";
import PostMeta from "@components/header-post-meta.astro";

export async function getStaticPaths() {
  let posts = await getCollection("post", ({ data }) => {
    if (data.tags) {
      return true;
    }
    return false;
  });

  const tags = [
    ...new Set(
      posts
        .map((post) => post.data.tags)
        .filter(Boolean)
        .flat()
    ),
  ];

  return tags.map((tag_name) => ({
    params: { tag_name },
    props: {
      entries: posts.filter((post) =>
        post.data.tags?.includes(tag_name as string)
      ),
    },
  }));
}

interface Props {
  entries: CollectionEntry<"post">[];
}

const { tag_name } = Astro.params;
const { entries } = Astro.props;
---

<Layout>
  <main class="prose">
    <h1>Tag: {tag_name}</h1>
    <ul>
      {
        entries.map((entry) => (
          <li>
            <a href={`/${entry.slug}`}>{entry.data.title}</a>
          </li>
        ))
      }
    </ul>
  </main>
  <PostMeta
    slot="page-meta"
    title={`chantastic posts tagged: ${tag_name}`}
    url={`http://chan.dev/tags/${tag_name}`}
  />
</Layout>
